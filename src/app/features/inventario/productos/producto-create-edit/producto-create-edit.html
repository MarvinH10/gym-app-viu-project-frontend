<div class="flex flex-col gap-6 w-full max-w-4xl mx-auto pb-10">
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div class="flex flex-col gap-2">
      <h1 class="text-3xl font-bold tracking-tight text-foreground">
        {{ productId() ? 'Editar Producto' : 'Crear Nuevo Producto' }}
      </h1>
      <p class="text-muted-foreground mt-2">
        {{
          productId()
            ? 'Modifica los detalles del producto seleccionado.'
            : 'Completa los campos para añadir un nuevo producto.'
        }}
      </p>
    </div>
  </div>

  @if (error()) {
    <div class="p-4 rounded-md bg-destructive/10 text-destructive text-sm flex items-center gap-3">
      <z-icon zType="triangle-alert" class="size-5 shrink-0" />
      <p>{{ error() }}</p>
    </div>
  }

  <z-card class="p-6">
    @if (loading()) {
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="md:col-span-2 flex flex-col gap-2">
          <z-skeleton class="h-4 w-36 rounded" />
          <z-skeleton class="h-10 w-full rounded-md" />
        </div>
        <div class="md:col-span-2 flex flex-col gap-2">
          <z-skeleton class="h-4 w-44 rounded" />
          <z-skeleton class="h-10 w-full rounded-md" />
        </div>
        <div class="flex flex-col gap-2">
          <z-skeleton class="h-4 w-40 rounded" />
          <z-skeleton class="h-10 w-full rounded-md" />
        </div>
        <div class="flex flex-col gap-2">
          <z-skeleton class="h-4 w-24 rounded" />
          <z-skeleton class="h-10 w-full rounded-md" />
        </div>
        <div class="flex flex-col gap-2">
          <z-skeleton class="h-4 w-32 rounded" />
          <z-skeleton class="h-10 w-full rounded-md" />
        </div>
        <div class="flex flex-col gap-2">
          <z-skeleton class="h-4 w-20 rounded" />
          <z-skeleton class="h-10 w-full rounded-md" />
        </div>
        <div class="md:col-span-2 flex justify-end gap-3 pt-2">
          <z-skeleton class="h-10 w-24 rounded-md" />
          <z-skeleton class="h-10 w-28 rounded-md" />
        </div>
      </div>
    } @else {
      <app-form-create-edit
        [fields]="productFormFields()"
        [initialData]="initialData()"
        [loading]="loading()"
        [isSubmitting]="isSubmitting()"
        [submitLabel]="productId() ? 'Guardar Cambios' : 'Crear Producto'"
        (formSubmit)="onFormSubmit($event)"
        (cancel)="onCancel()"
      >
        <div class="pt-4 mt-2 border-t border-border flex flex-col gap-4">
          <div class="flex items-center gap-2">
            <z-icon zType="tag" class="size-5 text-muted-foreground" />
            <h2 class="text-base font-semibold text-foreground">Atributos del Producto</h2>
            <z-badge zType="outline" class="ml-auto">{{ attributeLines().length }}</z-badge>
          </div>
          <p class="text-sm text-muted-foreground -mt-2">
            Define características como Talla, Color, Material, etc. y los valores disponibles.
          </p>

          @for (line of attributeLines(); track line.attribute_id; let i = $index) {
            <div class="rounded-lg border border-border bg-muted/20 px-4 pt-4 pb-3">
              <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-semibold text-foreground flex items-center gap-2">
                  <z-icon zType="layers" class="size-4 text-primary" />
                  {{ line.attribute_name }}
                </span>
                <button
                  type="button"
                  class="text-muted-foreground hover:text-destructive transition-colors p-1 rounded"
                  (click)="removeAttributeLine(i)"
                >
                  <z-icon zType="x" class="size-4" />
                </button>
              </div>

              @if (line.predefinedValues.length > 0) {
                <z-select
                  [zMultiple]="true"
                  [zValue]="getPredefinedSelection(line)"
                  (zSelectionChange)="onPredefinedSelectionChange(i, $event)"
                  zPlaceholder="Selecciona valores..."
                  class="w-full mb-3"
                >
                  @for (pv of line.predefinedValues; track pv) {
                    <z-select-item [zValue]="pv">{{ pv }}</z-select-item>
                  }
                </z-select>
              }

              @if (line.values.length > 0) {
                <div class="flex flex-wrap gap-1.5 mb-3">
                  @for (val of line.values; track val) {
                    <span
                      class="inline-flex items-center gap-1 text-xs bg-primary/15 text-primary border border-primary/30 px-2.5 py-1 rounded-full font-medium"
                    >
                      {{ val }}
                      <button
                        type="button"
                        class="hover:text-destructive transition-colors"
                        (click)="removeValueFromLine(i, val)"
                      >
                        <z-icon zType="x" class="size-3" />
                      </button>
                    </span>
                  }
                </div>
              } @else {
                <p class="text-xs text-muted-foreground italic mb-3">Sin valores seleccionados</p>
              }

              <!-- Input para valores custom (no en catálogo) -->
              <div class="flex gap-2">
                <input
                  z-input
                  type="text"
                  class="flex-1 h-9 text-sm"
                  [placeholder]="
                    line.predefinedValues.length > 0 ? 'Valor personalizado...' : 'Ej. Rojo, XL...'
                  "
                  [ngModel]="line.inputValue"
                  (ngModelChange)="updateLineInput(i, $event)"
                  (keydown)="onValueKeydown($event, i)"
                />
                <button
                  type="button"
                  z-button
                  zType="outline"
                  class="h-9 px-3"
                  (click)="addValueToLine(i)"
                  [disabled]="!line.inputValue.trim()"
                >
                  <z-icon zType="plus" class="size-4" />
                </button>
              </div>
              <p class="text-xs text-muted-foreground mt-1.5">
                {{
                  line.predefinedValues.length > 0
                    ? 'Agrega valores no listados arriba'
                    : 'Presiona Enter o + para agregar'
                }}
              </p>
            </div>
          }

          @if (availableAttributes().length > 0) {
            <div class="flex gap-2">
              <z-select
                [zValue]="selectedAttributeId()"
                (zSelectionChange)="selectedAttributeId.set($event.toString())"
                class="flex-1"
                zPlaceholder="— Selecciona un atributo —"
              >
                @for (attr of availableAttributes(); track attr.id) {
                  <z-select-item [zValue]="attr.id.toString()">{{ attr.name }}</z-select-item>
                }
              </z-select>
              <button
                type="button"
                z-button
                zType="outline"
                class="gap-2"
                (click)="addAttributeLine()"
                [disabled]="!selectedAttributeId()"
              >
                <z-icon zType="plus" class="size-4" />
                Agregar
              </button>
            </div>
          } @else if (attributes().length > 0) {
            <p
              class="text-sm text-muted-foreground text-center py-3 border border-dashed border-border rounded-lg"
            >
              Todos los atributos disponibles ya han sido agregados.
            </p>
          } @else {
            <p
              class="text-sm text-muted-foreground text-center py-3 border border-dashed border-border rounded-lg"
            >
              No hay atributos configurados aún.
            </p>
          }
        </div>
      </app-form-create-edit>
    }
  </z-card>
</div>
